<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Missed Connections NYC</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2rem;
        background: #f8f8f8;
      }
      h1 {
        text-align: center;
      }
      .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }
      .card {
        background: white;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 6px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }
      .card h3 {
        margin-top: 0;
      }
      iframe {
        margin-top: 0.5rem;
        border-radius: 4px;
      }
      #results-count {
        margin: 1rem 0;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ—½ Missed Connections NYC</h1>

    <div class="filters">
      <input type="text" id="search" placeholder="Search keyword..." />
      <select id="locationFilter">
        <option value="">All Locations</option>
      </select>
      <select id="sort">
        <option value="newest">Sort: Newest</option>
        <option value="oldest">Sort: Oldest</option>
      </select>
    </div>

    <p id="results-count"></p>
    <div id="posts-container"></div>

    <script>
      async function fetchData() {
        const res = await fetch(
          "https://jinnic.github.io/craigslist_scrape/data/craigslist_missed_connections.json"
        );
        const json = await res.json();
        return json.data;
      }

      function renderPosts(posts) {
        const container = document.getElementById("posts-container");
        container.innerHTML = "";

        posts.forEach((post) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
          <h3>${post.title}</h3>
          <p><strong>${post.location}</strong> â€” ${new Date(
            post.date_posted
          ).toLocaleDateString()}</p>
          <p>${post.post_text}</p>
          <a href="${post.url}" target="_blank">View original post</a>
        `;

          // Optional embedded map
          if (post.coordinates !== "N/A") {
            const [lat, lon] = post.coordinates.split(",");
            div.innerHTML += `
            <iframe width="100%" height="200" frameborder="0"
              src="https://maps.google.com/maps?q=${lat},${lon}&z=14&output=embed">
            </iframe>`;
          }

          container.appendChild(div);
        });
      }

      function filterPosts(posts, keyword, location) {
        return posts.filter(
          (post) =>
            (!keyword ||
              post.post_text.toLowerCase().includes(keyword.toLowerCase())) &&
            (!location || post.location === location)
        );
      }

      function sortPosts(posts, sortBy) {
        return [...posts].sort((a, b) => {
          const dateA = new Date(a.date_posted);
          const dateB = new Date(b.date_posted);
          return sortBy === "oldest" ? dateA - dateB : dateB - dateA;
        });
      }

      function updateCount(count) {
        document.getElementById(
          "results-count"
        ).textContent = `${count} result(s) found`;
      }

      function populateLocationFilter(posts) {
        const locationSelect = document.getElementById("locationFilter");
        const locations = [
          ...new Set(posts.map((post) => post.location).filter(Boolean)),
        ].sort();

        locations.forEach((loc) => {
          const option = document.createElement("option");
          option.value = loc;
          option.textContent = loc;
          locationSelect.appendChild(option);
        });
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const posts = await fetchData();
        populateLocationFilter(posts);
        updateCount(posts.length);
        renderPosts(sortPosts(posts, "newest"));

        function updateView() {
          const keyword = document.getElementById("search").value;
          const location = document.getElementById("locationFilter").value;
          const sort = document.getElementById("sort").value;

          const filtered = filterPosts(posts, keyword, location);
          updateCount(filtered.length);
          renderPosts(sortPosts(filtered, sort));
        }

        document.getElementById("search").addEventListener("input", updateView);
        document
          .getElementById("locationFilter")
          .addEventListener("change", updateView);
        document.getElementById("sort").addEventListener("change", updateView);
      });
    </script>
  </body>
</html>
